<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>New Canvas</title>
    <style>
        .dialogue {
            margin-top: 20vh;
            margin-left: 25vw;
            width: 50vw;
            border: 1px solid lightgray;
            border-radius: 10px;
            padding: 1em;
        }
        
        .row {
            padding-bottom: 1em;
        }
        
        small {
            clear: both;
        }
        
        .try {
            margin: 10vw;
            font-size: smaller;
        }
        
        #mediaInfo {
            display: none;
        }
        
        #imgPreview {
            float: left;
            margin-right: 1em;
            padding-bottom: 1em;
            max-width: 120px;
            max-height: 120px;
        }
        
        #imgService {
            float: left;
            max-width: 20vw;
            font-size: smaller;
        }
        
        #manifestPreview {
            padding-top: 1em;
            font-size: smaller;
        }
        
        h5 {
            clear: both;
        }
        
        #canvasFromDimensions {
            display: none;
        }
        
        #canvasFromContent {
            margin-top: 1.5rem;
        }
        
        hr {
            clear: both;
        }
        
        #canvasDimensionMessage {
            font-size: small;
            clear: left;
        }
    </style>
</head>

<body>

    <div class="dialogue">

        <h5>Add Canvas</h5>
        <form>
            <div id="canvasFromContent">
                <div class="input-group">
                    <input type="text" id="mediaUrl" class="form-control" placeholder="Paste URL of Media to create Canvas" aria-label="URL of Media" aria-describedby="mediaHelp">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" id="refreshUrl" type="button">‚ü≥</button>
                    </div>
                </div>
                <small id="mediaHelp" class="form-text text-muted">
                    From content: any image, IIIF Image Service, audio, video or IIIF Manifests and Canvases
                </small>

                <div id="mediaInfo">
                    <img id="imgPreview" />
                    <div id="staticImg"><br/> This is a Static Image.</div>
                    <div id="imgService"><br/><img src="https://iiif.io/assets/images/logos/logo-sm.png" id="iiifLogo" /> This is a IIIF Image Service</div>
                    <div id="manifestPreview"><img src="https://iiif.io/assets/images/logos/logo-sm.png" id="iiifLogo" /> This is a IIIF Manifest.<br/> TBC - this would show <a href="../contentstate/cs.html">IIIF Browser</a> to select a canvas, or just the single canvas if there's
                        only one.</div>
                    <p id="canvasDimensionMessage"></p>
                </div>
            </div>

            <div id="canvasFromDimensions">
                <div class="form-group row">
                    <div class="col">
                        <label for="width">Width</label>
                        <input type="text" class="form-control" id="width" placeholder="n/a">
                    </div>
                    <div class="col">
                        <label for="height">Height</label>
                        <input type="text" class="form-control" id="height" placeholder="n/a">
                    </div>
                    <div class="col">
                        <label for="duration">Duration</label>
                        <input type="text" class="form-control" id="duration" placeholder="n/a">
                    </div>
                </div>
            </div>

            <hr/>
            <div class="form-group row">
                <div class="col">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="emptyCanvas">
                        <label class="form-check-label" for="emptyCanvas">
                          Empty Canvas
                        </label>
                    </div>
                </div>
                <div class="col">
                </div>
                <div class="col">
                    <button type="submit" class="btn btn-primary">Add Canvas</button>
                    <button type="submit" class="btn btn-primary">Cancel</button>
                </div>
            </div>
        </form>
    </div>

    <div class="try">
        <h2>Try these:</h2>
        <p>NB smoke and mirrors going on here.</p>
        <ul>
            <li>Image: <a href="https://upload.wikimedia.org/wikipedia/commons/4/4d/NASA_Apollo_17_Lunar_Roving_Vehicle.jpg">https://upload.wikimedia.org/wikipedia/commons/4/4d/NASA_Apollo_17_Lunar_Roving_Vehicle.jpg</a></li>
            <li>Image Service: <a href="https://iiif.wellcomecollection.org/image/b19431132_ms_2000_0006.JP2">https://iiif.wellcomecollection.org/image/b19431132_ms_2000_0006.JP2</a></li>
            <li>Image Service: <a href="https://iiif.wellcomecollection.org/image/b19431132_ms_2000_0006.JP2/info.json">https://iiif.wellcomecollection.org/image/b19431132_ms_2000_0006.JP2/info.json</a></li>
            <li>Image Service: <a href="https://iiif.wellcomecollection.org/image/b19431132_ms_2000_0006.JP2/full/1000,/0/default.jpg">https://iiif.wellcomecollection.org/image/b19431132_ms_2000_0006.JP2/full/1000,/0/default.jpg</a></li>
            <li>Manifest: <a href="https://iiif.wellcomecollection.org/presentation/b19431132">https://iiif.wellcomecollection.org/presentation/b19431132</a></li>
        </ul>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>
        function $(id) {
            return document.getElementById(id);
        }

        $("mediaUrl").addEventListener("change", analyseUrl);
        $("refreshUrl").addEventListener("click", analyseUrl);
        $("imgPreview").addEventListener("load", function() {
            if ($("staticImg").style.display == "block") {
                setDimensions(this.naturalWidth, this.naturalHeight);
            }
        });
        $("emptyCanvas").addEventListener("change", function() {
            if (this.checked) {
                $("canvasFromDimensions").style.display = "block";
                $("canvasFromContent").style.display = "none";
            } else {
                $("canvasFromDimensions").style.display = "none";
                $("canvasFromContent").style.display = "block";
            }
        });

        function analyseUrl() {
            // This is, quite obviously, not an implementation of
            // https://github.com/digirati-co-uk/iiif-manifest-editor/issues/45
            let url = $("mediaUrl").value.trim();
            $("mediaInfo").style.display = "none";
            $("imgPreview").style.display = "none";
            $("staticImg").style.display = "none";
            $("imgService").style.display = "none";
            $("manifestPreview").style.display = "none";
            $("canvasDimensionMessage").innerText = "";
            if (url) {
                $("mediaInfo").style.display = "block";
                const ringer = "https://iiif.wellcomecollection.org/image/b19431132_ms_2000_0006.JP2";
                if (url.indexOf(ringer) != -1) {
                    url = ringer + "/info.json";
                    fetch(url).then(response => response.json()).then(info => {
                        $("imgPreview").style.display = "block";
                        $("imgService").style.display = "block";
                        setDimensions(info.width, info.height);
                        $("imgPreview").src = ringer + "/full/!200,200/0/default.jpg";
                    });
                } else if (url.indexOf("wellcomecollection.org/presentation") != -1) {
                    $("manifestPreview").style.display = "block";
                } else {
                    // assume this is a static image                                          
                    $("imgPreview").style.display = "block";
                    $("staticImg").style.display = "block";
                    $("imgPreview").src = url;
                }
            }
        }

        function setDimensions(width, height) {
            // This is no longer in the spec for 3.0, but maybe we want to do it
            // can be a config flag
            while (width < 1200 || height < 1200) {
                width = width * 2;
                height = height * 2;
            }
            $("width").value = width;
            $("height").value = height;
            $("duration").value = "";

            // this would come from config:
            const template = "This image/service is {width} x {height}, the Manifest Editor will create a Canvas {width} x {height} from this image/service";
            let msg = template.replaceAll("{width}", width);
            msg = msg.replaceAll("{height}", height);
            $("canvasDimensionMessage").innerText = msg;
        }
    </script>
</body>

</html>